From fb342fdb60391073a69147cb71af1ac416a81099 Mon Sep 17 00:00:00 2001
From: Chris Liddell <chris.liddell@artifex.com>
Date: Wed, 14 Jun 2023 09:08:12 +0100
Subject: [PATCH] Bug 706778: 706761 revisit

Two problems with the original commit. The first a silly typo inverting the
logic of a test.

The second was forgetting that we actually actually validate two candidate
strings for pipe devices. One with the expected "%pipe%" prefix, the other
using the pipe character prefix: "|".

This addresses both those.
---
 base/gpmisc.c   | 2 +-
 base/gslibctx.c | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

--- a/base/gpmisc.c
+++ b/base/gpmisc.c
@@ -1080,7 +1080,7 @@ gp_validate_path_len(const gs_memory_t *
     /* "%pipe%" do not follow the normal rules for path definitions, so we
        don't "reduce" them to avoid unexpected results
      */
-    if (len > 5 && memcmp(path, "%pipe", 5) != 0) {
+    if (path[0] == '|' || (len > 5 && memcmp(path, "%pipe", 5) == 0)) {
         bufferfull = buffer = (char *)gs_alloc_bytes(mem->thread_safe_memory, len + 1, "gp_validate_path");
         if (buffer == NULL)
             return gs_error_VMerror;
--- a/base/gslibctx.c
+++ b/base/gslibctx.c
@@ -748,7 +748,7 @@ gs_add_control_path_len_flags(const gs_m
     /* "%pipe%" do not follow the normal rules for path definitions, so we
        don't "reduce" them to avoid unexpected results
      */
-    if (len > 5 && memcmp(path, "%pipe", 5) != 0) {
+    if (path[0] == '|' || (len > 5 && memcmp(path, "%pipe", 5) == 0)) {
         buffer = (char *)gs_alloc_bytes(core->memory, len + 1, "gs_add_control_path_len");
         if (buffer == NULL)
             return gs_error_VMerror;
@@ -855,7 +855,7 @@ gs_remove_control_path_len_flags(const g
     /* "%pipe%" do not follow the normal rules for path definitions, so we
        don't "reduce" them to avoid unexpected results
      */
-    if (len > 5 && memcmp(path, "%pipe", 5) != 0) {
+    if (path[0] == '|' || (len > 5 && memcmp(path, "%pipe", 5) == 0)) {
         buffer = (char *)gs_alloc_bytes(core->memory, len + 1, "gs_remove_control_path_len");
         if (buffer == NULL)
             return gs_error_VMerror;
