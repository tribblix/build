#!/bin/sh
#
# {{{ CDDL HEADER
#
# This file and its contents are supplied under the terms of the
# Common Development and Distribution License ("CDDL"), version 1.0.
# You may only use this file in accordance with the terms of version
# 1.0 of the CDDL.
#
# A full copy of the text of the CDDL should have accompanied this
# source. A copy of the CDDL is also available via the Internet at
# http://www.illumos.org/license/CDDL.
#
# }}}
#
# Copyright 2023 Peter Tribble
#

#
# simple wrapper to create python module metadata
#
# you may need to modify the depend file
#

#
# by default, package for 3.11
#

PY311VER=311

DO311="yes"

case $1 in
    -p)
	BUILDER=pkg_pep518
	shift
	;;
    -s)
	BUILDER=pkg_setup_py
	shift
	;;
    -w)
	BUILDER=pkg_wheel
	PKGVERS=$2
	shift
	shift
	;;
    *)
	echo "Usage: $0 -s|-p pkg_name tarball_name"
	echo "       $0 -w pkg_version pkg_name tarball_name"
	exit 1
	;;
esac

case $# in
2)
	pkg_name=$1
	TBALL=$2
	;;
*)
	echo "Usage: $0 -s|-p pkg_name tarball_name"
	echo "       $0 -w pkg_version pkg_name tarball_name"
	exit 1
	;;
esac

PY311NAME=TRIB${pkg_name}-python-${PY311VER}

#
# check we're within the SVR4 package name length limit
#
NAMELEN=${#PY311NAME}
if [ $NAMELEN -gt 31 ]; then
    echo "Chosen name exceeds the SVR4 package name length limit (length $NAMELEN)"
    exit 1
fi

if [ -d "$PY311NAME" ]; then
   echo "$PY311NAME already exists"
   exit 1
fi

#
# the pypi name ought to match the tarball name
# with the version number stripped off
#
PNAME=${TBALL%-*}
PVER=${TBALL##*-}

#
# for wheels it's a bit more complicated to guess the version from the file
# so we're passed the version explicitly
#
if [ -n "${PKGVERS}" ]; then
    PVER=${PKGVERS}
    PNAME=${TBALL%-${PVER}*}
fi

#
# OK, now we can create the package metadata
#

if [ -n "$DO311" ]; then
#
# python 3.11
#
mkdir $PY311NAME
echo "P TRIBv-python-$PY311VER" > $PY311NAME/depend
cat > $PY311NAME/pkginfo <<EOF
PKG="${PY311NAME}"
NAME="Python $PNAME"
VERSION="${PVER}.0"
ZAP_URL="https://pypi.org/project/${PNAME}"
EOF
cat > $PY311NAME/build.sh <<EOF
#!/bin/sh
#
\${THOME}/build/$BUILDER $PY311NAME $TBALL
EOF
chmod a+x $PY311NAME/build.sh
fi
