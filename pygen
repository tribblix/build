#!/bin/sh
#
# simple wrapper to create python module metadata
#
# you may need to modify the depend file
#

#
# by default, package for 3.9, other versions optional
#

PY37VER=37
PY37DVER=3.7
PY39VER=39
PY39DVER=3.9
PY310VER=310
PY310DVER=3.10

DO37=""
DO310=""
case $1 in
    +37)
	DO37="yes"
	shift
	;;
esac
case $1 in
    +310)
	DO310="yes"
	shift
	;;
esac

case $1 in
    -p)
	BUILDER=pkg_pep518
	shift
	;;
    -s)
	BUILDER=pkg_setup_py
	shift
	;;
    *)
	echo "Usage: $0 -s|-p pkg_name tarball_name"
	exit 1
	;;
esac

case $# in
2)
	pkg_name=$1
	TBALL=$2
	;;
*)
	echo "Usage: $0 -s|-p pkg_name tarball_name"
	exit 1
	;;
esac

PY37NAME=TRIB${pkg_name}-python-${PY37VER}
PY39NAME=TRIB${pkg_name}-python-${PY39VER}
PY310NAME=TRIB${pkg_name}-python-${PY310VER}

if [ -d "$PY37NAME" ]; then
   echo "$PY37NAME already exists"
   exit 1
fi
if [ -d "$PY39NAME" ]; then
   echo "$PY39NAME already exists"
   exit 1
fi
if [ -d "$PY310NAME" ]; then
   echo "$PY310NAME already exists"
   exit 1
fi

#
# the pypi name ought to match the tarball name
# with the version number stripped off
#
PNAME=${TBALL%-*}
PVER=${TBALL##*-}

#
# OK, now we can create the package metadata
#

if [ -n "$DO37" ]; then
#
# python 3.7
#
mkdir $PY37NAME
echo "P TRIBv-python-$PY37VER" > $PY37NAME/depend
cat > $PY37NAME/pkginfo <<EOF
PKG="${PY37NAME}"
NAME="Python $PNAME"
VERSION="${PVER}.0"
ZAP_URL="https://pypi.org/project/${PNAME}"
EOF
cat > $PY37NAME/build.sh <<EOF
#!/bin/sh
#
\${THOME}/build/unpack$BUILDER $PY37NAME $TBALL
EOF
chmod a+x $PY37NAME/build.sh
fi

#
# python 3.9
#
mkdir $PY39NAME
echo "P TRIBv-python-$PY39VER" > $PY39NAME/depend
cat > $PY39NAME/pkginfo <<EOF
PKG="${PY39NAME}"
NAME="Python $PNAME"
VERSION="${PVER}.0"
ZAP_URL="https://pypi.org/project/${PNAME}"
EOF
cat > $PY39NAME/build.sh <<EOF
#!/bin/sh
#
\${THOME}/build/$BUILDER $PY39NAME $TBALL
EOF
chmod a+x $PY39NAME/build.sh

if [ -n "$DO310" ]; then
#
# python 3.10
#
mkdir $PY310NAME
echo "P TRIBv-python-$PY310VER" > $PY310NAME/depend
cat > $PY310NAME/pkginfo <<EOF
PKG="${PY310NAME}"
NAME="Python $PNAME"
VERSION="${PVER}.0"
ZAP_URL="https://pypi.org/project/${PNAME}"
EOF
cat > $PY310NAME/build.sh <<EOF
#!/bin/sh
#
\${THOME}/build/unpack$BUILDER $PY310NAME $TBALL
EOF
chmod a+x $PY310NAME/build.sh
fi
