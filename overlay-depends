#!/bin/sh
#
# generate a merged list of dependencies for the given overlay(s)
#

THOME=${THOME:-/packages/localsrc/Tribblix}
#
# xref against this illumos catalog
#
ILVER=m31
case `pwd` in
    *lx)
	ILVER=m31lx
	;;
    *sparc)
	ILVER=m27.sparc
	;;
esac
CATALOG=${THOME}/illumos-pkgs-${ILVER}/pkgs/catalog

#
VERBOSE=""
case $1 in
-v)
    # must come first, and pass it on
    VERBOSE="-v"
    shift
    ;;
esac

case $1 in
-a)
    # look for all overlays
    for pkg in *.pkgs
    do
	$0 $VERBOSE ${pkg%.pkgs}
    done
    exit 0
    ;;
-f)
    # useful for overlays.iso
    if [ -f $2 ]; then
	for pkg in `cat $2`
	do
	    $0 $VERBOSE $pkg
	done
    else
	echo "Missing file $2"
    fi
    exit 0
    ;;
esac

case $# in
1)
	OVL="$1"
	;;
*)
	echo "Usage: $0 [-v] -a|overlay|-f listfile"
	exit 1
	;;
esac
if [ ! -f "${OVL}.pkgs" ]; then
    echo "ERROR: unable to find overlay $OVL"
    exit 1
fi
TMPF=/tmp/ovtmp.$$
rm -f $TMPF
touch $TMPF
for PKGI in `cat ${OVL}.pkgs`
do
  if [ -f ../build/${PKGI}/depend ]; then
     grep '^P' ../build/${PKGI}/depend >> $TMPF
  fi
  if [ ! -d ../build/${PKGI} ]; then
      for npkgi in $(awk -v p=$PKGI -F'|' '{if ($1 == p) print $3}' $CATALOG)
      do
	  echo "P $npkgi" >> $TMPF
      done
  fi
done
#
# find any dependencies that aren't handled by prerequisite overlays
#
POVL=`awk -F= '{if ($1 == "REQUIRES") print $2".ovl"}' base.ovl ${OVL}.ovl`
cat base.pkgs >> ${TMPF}.p
if [ -n "$POVL" ]; then
  cat ${POVL//.ovl/.pkgs} >> ${TMPF}.p
  PPOVL=`awk -F= '{if ($1 == "REQUIRES") print $2".ovl"}' ${POVL}`
  if [ -n "$PPOVL" ]; then
    cat ${PPOVL//.ovl/.pkgs} >> ${TMPF}.p
    PPPOVL=`awk -F= '{if ($1 == "REQUIRES") print $2".ovl"}' ${PPOVL}`
    if [ -n "$PPPOVL" ]; then
      cat ${PPPOVL//.ovl/.pkgs} >> ${TMPF}.p
      PPPPOVL=`awk -F= '{if ($1 == "REQUIRES") print $2".ovl"}' ${PPPOVL}`
      if [ -n "$PPPPOVL" ]; then
	  cat ${PPPPOVL//.ovl/.pkgs} >> ${TMPF}.p
      fi
    fi
  fi
fi
sort -u ${TMPF}.p > ${TMPF}.t
awk '{print $2}' $TMPF | sort -u > ${TMPF}.u
OUTMISS=`/usr/bin/fgrep -v -x -f ${OVL}.pkgs ${TMPF}.u | /usr/bin/fgrep -v -x -f ${TMPF}.t`
if [ -n "${OUTMISS}" ]; then
    echo ""
    echo "Missing dependencies in overlay ${OVL}:"
    echo "============================================="
    /usr/bin/fgrep -v -x -f ${OVL}.pkgs ${TMPF}.u | /usr/bin/fgrep -v -x -f ${TMPF}.t
fi

if [ "X$VERBOSE" = "X-v" ]; then
for ndep in `/usr/bin/fgrep -v -f ${OVL}.pkgs ${TMPF}.u | /usr/bin/fgrep -v -f ${TMPF}.t`
do
for PKGI in `cat ${OVL}.pkgs`
do
  if [ -f ../build/${PKGI}/depend ]; then
     grep -w $ndep ../build/${PKGI}/depend /dev/null
  fi
  if [ ! -d ../build/${PKGI} ]; then
      egrep "( |\|)${ndep}( |\|)" $CATALOG | awk -v p=$PKGI -F'|' '{if ($1 == p) print $1" : " $3}'
  fi
done
done
fi

#
# check syntax of the ovl file
#
OUTMISS=`egrep -v '^(VERSION|NAME|REQUIRES|SERVICE)=' ${OVL}.ovl`
if [ -n "${OUTMISS}" ]; then
    echo ""
    echo "Invalid syntax in ${OVL}.ovl:"
    echo "============================================="
    egrep -v '^(VERSION|NAME|REQUIRES|SERVICE)=' ${OVL}.ovl
fi

rm -f $TMPF ${TMPF}.t ${TMPF}.p
